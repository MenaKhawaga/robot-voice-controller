<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Robot Voice Controller</title>
          <style>
            body {
                margin: 0;
                height: 100vh;            /* make the body take the full height of the screen */
                display: flex;            /* turn the body into a Flex Container */
                justify-content: center;  /* center the card horizontally */
                align-items: center;      /* center the card vertically */
                background-image: linear-gradient(90deg, #A100FFFF 0%, #71C4FFFF 100%);
                color: #ffffff;
                text-align: center;
            }

            .card {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 20px;
                box-shadow: 0 0 32px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.18);
                padding:40px;
            }


            #mic-btn {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                background-color: #ffffff;
                border: none;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 65px; 
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                margin: 0 auto;

            }

            #mic-btn:hover {
                transform: scale(1.3);
            } 
            
          
            
            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 20px rgba(255, 255, 255, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
                }
            }
            
            .listening {
                animation: pulse 2s infinite; 
            }
            
            #transcript {
                margin-top: 30px;
                font-size: 1.2em;
            }
        </style>
        
    </head>
    <body>
      
        <div class="card">

        <h1 >Robot Voice Controller ü§ñ</h1>
        <h3> Say: Go ahead - Go back - Turn left - Turn right - Stop </h3>
        <button id="mic-btn" >üéôÔ∏è</button>
        <div id="transcript">Click the mic to give a command</div>
        <div id="connection-status">Checking connection...</div>
        
        <div id="instructions" style="margin-top: 20px; font-size: 0.9em; text-align: left; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 10px;">
            <h4 style="margin-top: 0;">How to connect to your NodeMCU:</h4>
            <ol style="padding-left: 20px;">
                <li>Power on your NodeMCU robot</li>
                <li>Connect to the WiFi network created by NodeMCU (usually named "Robot_AP")</li>
                <li>Click the ‚öôÔ∏è Settings button below</li>
                <li>Enter the NodeMCU's IP address (default is 192.168.4.1)</li>
                <li>Click Save and wait for connection</li>
            </ol>
            <div style="margin-top: 10px; padding: 5px; background: rgba(255, 200, 0, 0.2); border-radius: 5px;">
                <strong>‚ö†Ô∏è GitHub Pages Note:</strong> When using this page from GitHub (https), you may need to:
                <ol style="padding-left: 20px;">
                    <li>Click the lock/shield icon in your browser's address bar</li>
                    <li>Allow "insecure content" or "mixed content" for this site</li>
                    <li>Or use the page in HTTP mode by changing https:// to http:// in the URL</li>
                </ol>
            </div>
        </div>

        </div>

        <style>
            #connection-status {
                margin-top: 15px;
                font-size: 0.9em;
                color: #ffffff;
                padding: 5px 10px;
                border-radius: 10px;
                display: inline-block;
            }
            .connected {
                background-color: rgba(0, 255, 0, 0.3);
            }
            .disconnected {
                background-color: rgba(255, 0, 0, 0.3);
            }
        </style>
        <script>
            const micButton = document.getElementById("mic-btn")
            const transcriptDiv = document.getElementById("transcript")
            
            // Robot IP configuration - stored in localStorage for persistence
            let robotIP = localStorage.getItem('robotIP') || "192.168.4.1";
            let isConnected = false;
            
            // Create settings panel for IP configuration
            const settingsHTML = `
                <div id="settings-panel" style="display: none; margin-top: 20px;">
                    <input type="text" id="ip-input" placeholder="Robot IP Address" value="${robotIP}">
                    <button id="save-ip">Save</button>
                </div>
                <button id="settings-toggle" style="margin-top: 15px; background: rgba(255,255,255,0.2); border: none; padding: 5px 10px; border-radius: 5px; color: white; cursor: pointer;">‚öôÔ∏è Settings</button>
            `;
            document.querySelector('.card').insertAdjacentHTML('beforeend', settingsHTML);
            
            // Settings toggle functionality
            document.getElementById('settings-toggle').addEventListener('click', () => {
                const panel = document.getElementById('settings-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });
            
            // Save IP functionality
            document.getElementById('save-ip').addEventListener('click', () => {
                const newIP = document.getElementById('ip-input').value.trim();
                if (newIP) {
                    robotIP = newIP;
                    localStorage.setItem('robotIP', robotIP);
                    checkConnection();
                    document.getElementById('settings-panel').style.display = 'none';
                }
            });
            
            // Check connection on page load
            checkConnection();
            
            // Connection check with retry mechanism
            function checkConnection(retryCount = 0, maxRetries = 3) {
                const statusDiv = document.getElementById("connection-status");
                statusDiv.textContent = "Checking connection...";
                statusDiv.className = "";
                
                // Try to use protocol that matches the current page (HTTPS for GitHub Pages, HTTP for local)
                const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
                fetch(`${protocol}//${robotIP}/`, { 
                    mode: 'no-cors', 
                    timeout: 3000 
                })
                .then(() => {
                    updateConnectionStatus(true);
                })
                .catch(() => {
                    if (retryCount < maxRetries) {
                        statusDiv.textContent = `Connection failed. Retrying (${retryCount + 1}/${maxRetries})...`;
                        setTimeout(() => checkConnection(retryCount + 1, maxRetries), 2000);
                    } else {
                        updateConnectionStatus(false);
                    }
                });
            }
            
            function updateConnectionStatus(connected) {
                isConnected = connected;
                const statusDiv = document.getElementById("connection-status");
                if (connected) {
                    statusDiv.textContent = "Connected to Robot";
                    statusDiv.className = "connected";
                } else {
                    statusDiv.innerHTML = "Disconnected - <button id='reconnect-btn' style='background: rgba(255,255,255,0.3); border: none; padding: 2px 8px; border-radius: 5px; color: white; cursor: pointer;'>Reconnect</button>";
                    statusDiv.className = "disconnected";
                    
                    // Add reconnect button functionality
                    document.getElementById('reconnect-btn').addEventListener('click', () => {
                        checkConnection();
                    });
                }
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = "en-US"; 
            recognition.continuous = false;

            recognition.onstart = function(){
                micButton.classList.add('listening');
                transcriptDiv.textContent = "Listening....";
            };

            recognition.onresult = function(event){
                let transcript = event.results[0][0].transcript.toLowerCase();

                transcript = transcript.replace(/[".]/g, '');     // Remove all double quotes and periods
                transcriptDiv.textContent = `You said: ${transcript}`;
                
                let command = '';
                if(transcript.includes('go ahead')) command = "forward";
                else if(transcript.includes("go back")) command = "backward";
                else if(transcript.includes("turn right")) command = "right";
                else if(transcript.includes("turn left")) command = "left";
                else if(transcript.includes("stop")) command = "stop";

                if(command) {
                    if (!isConnected) {
                        transcriptDiv.textContent = "Cannot send command: Robot not connected";
                        checkConnection(); // Try to reconnect
                        return;
                    }
                    
                    transcriptDiv.textContent = "Sending command: " + command;
                    
                    // Use the same protocol as the page
                    const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
                    fetch(`${protocol}//${robotIP}/cmd?cmd=${command}`)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! Status: ${res.status}`);
                        }
                        return res.text();
                    })
                    .then(data => {
                        console.log(data);
                        transcriptDiv.textContent = "Robot Status: " + data;
                        updateConnectionStatus(true);
                    })
                    .catch(err => {
                        console.error(err);
                        transcriptDiv.textContent = "Error: Could not send command to robot";
                        updateConnectionStatus(false);
                    });
                }
            };

            recognition.onend = function(){
                micButton.classList.remove('listening');
            };

            recognition.onerror = function(event) {
                    transcriptDiv.textContent = 'Error occurred: ' + event.error;
                };

            micButton.addEventListener('click', () => {
            recognition.start();
            });


            

        </script>


    </body>
    </html>
